---
title: "NINDS outcomes"
author: "David C. Norris"
date: "6/7/2018"
output: pdf_document
header-includes:
- \usepackage{setspace}
- \usepackage{relsize}
- \usepackage{multirow}
---

```{r setup, include=FALSE, echo=FALSE}
knitr::opts_chunk$set(echo = FALSE)
library(rms)
library(latticeExtra)
load("ninds.Rdata")
```

# NINDS Outcomes Visualization

Initially, I must gain visual insight into the longitudinal, multivariate outcomes
measured in NINDS, including infarct volumes and the multiple clinical assessments.
Of particular interest will be the *concordance* of objective and clinical measures.
I'll aim to explore this concordance with well-designed data graphics.

Let me begin with serialized measures of NIHSS (nihssb, hour2, hour24, seventen, ninety)
and CT lesion sizes (lesvol, les24, les710, les3m). To 'stratify' cases by *severity*,
let me exclude cases of hemorrhage and sort by the **3-month** lesion volume on CT.

```{r longitudinal, fig.height=6.5}
id <- rownames(ninds)
long <- with(ninds,
             rbind(data.frame(id=id, t=0, vol=lesvol, nihss=nihssb, flike=flike)
                  ,data.frame(id=id, t=0.083, vol=NA, nihss=hour2, flike=flike)
                  ,data.frame(id=id, t=1, vol=les24, nihss=hour24, flike=flike)
                  ,data.frame(id=id, t=7, vol=les710, nihss=seventen, flike=flike)
                  ,data.frame(id=id, t=90, vol=les3m, nihss=ninety, flike=flike)
                  )
)
label(long$vol) <- "CT lesion volume"
label(long$nihss) <- "NIH Stroke Scale"
#units(long$vol) <- '???'
long <- long[order(long$id),]
rownames(long) <- NULL

# Restrict to cases with all 4 CTs
got4 <- with(long, aggregate(!is.na(vol) ~ id, FUN=sum))
names(got4)[2] <- 'count_CTs'
got4 <- subset(got4, count_CTs==4)$id
long4CTs <- subset(long, id %in% got4)

# Further restrict to cases WITHOUT ICH
no_ich <- rownames(subset(ninds, !is.na(h36cens) & !h36cens))
long4CTs <- subset(long4CTs, id %in% no_ich)

# Order cases by decreasing severity (in terms of final lesion volume)
vol3m <- subset(long4CTs, t==90)
vol3m_decr <- vol3m[order(vol3m$vol, decreasing=TRUE),]
long4CTs$id <- ordered(long4CTs$id, levels=vol3m_decr$id)
long4CTs <- long4CTs[order(long4CTs$id),]

# Make 2 plot for overlay
left <- xYplot(vol ~ t^0.25 | id, data=subset(long4CTs[1:500,], !is.na(vol)), type='l'
               , xlab=expression(t^(1/4))
               , par.strip.text=list(cex=0.7)
               , layout=c(10,NA)
               , as.table=TRUE
               )
right <- xYplot(nihss ~ t^0.25 | id, data=long4CTs[1:500,], type='l')

# Overlay
doubleYScale(left, right, add.ylab2=TRUE)
```

From the above, I gather that many of these cases do not tell the simple story I would have expected: that the first day (or week) after the stroke, the damage consolidates. Some cases (e.g., 497938, 5958911 and 4406493) seem to show a 2nd stroke occurring during the first 90 days. So apparently I must read up on the details of stroke imaging!

Pending this, however, let my try restricting to cases of cardioembolic stroke, in the hope that some of the worst effects here come from 'large vessel occlusions'.

```{r stratify, fig.height=6.5}
#densityplot(~ les3m | flike, data=ninds)
long4CTs_cardio <- subset(long4CTs, flike=='Cardioembolic Stroke')
left_ce <- xYplot(vol ~ t^0.25 | id, data=subset(long4CTs_cardio[1:500,], !is.na(vol)), type='l'
               , xlab=expression(t^(1/4))
               , par.strip.text=list(cex=0.7)
               , layout=c(10,NA)
               , as.table=TRUE
               )
right_ce <- xYplot(nihss ~ t^0.25 | id, data=long4CTs_cardio[1:500,], type='l')

# Overlay
doubleYScale(left_ce, right_ce, add.ylab2=TRUE)

```

Well, look at that! Upon eyeballing this array, I gain the distinct impression of 'less surprising' clinical and imaging courses. The CT lesion volumes exhibit more convexity and asymptote-like behavior.

# Correlation of lesion volume with NIHSS

```{r vol_v_outcome3m, fig.height=6.5}
xYplot(ninety ~ (les3m)^(1), data=subset(ninds, flike=='Cardioembolic Stroke'))
```

```{r vol_v_outcome710, fig.height=6.5}
xYplot(seventen ~ (les710)^(1), data=subset(ninds, flike=='Cardioembolic Stroke'))
```

```{r vol_v_outcome24, fig.height=6.5}
xYplot(hour24 ~ (les24)^(1), data=subset(ninds, flike=='Cardioembolic Stroke'))
```

# Cumulative distribution comparison for lesion volumes

Next, I want to compare the distribution of lesion volumes between treated and untreated.

```{r compare_vol3m}
ninds_ce <- subset(ninds, flike=='Cardioembolic Stroke' & !is.na(les3m))
ninds_ce <- ninds_ce[order(ninds_ce$les3m),]
treated <- subset(ninds_ce, treated)
placebo <- subset(ninds_ce, !treated)
treated$F <- 1
placebo$F <- 1
treated$F <- cumsum(treated$F)
placebo$F <- cumsum(placebo$F)
treated$F <- treated$F / max(treated$F)
placebo$F <- placebo$F / max(placebo$F)
both <- rbind(treated, placebo)
xYplot(F ~ les3m, group=treatcd, data=both, type='l', auto.key=list(columns=2))
```

```{r compare_vol710}
ninds_ce <- subset(ninds, flike=='Cardioembolic Stroke' & !is.na(les710))
ninds_ce <- ninds_ce[order(ninds_ce$les710),]
treated <- subset(ninds_ce, treated)
placebo <- subset(ninds_ce, !treated)
treated$F <- 1
placebo$F <- 1
treated$F <- cumsum(treated$F)
placebo$F <- cumsum(placebo$F)
treated$F <- treated$F / max(treated$F)
placebo$F <- placebo$F / max(placebo$F)
both <- rbind(treated, placebo)
xYplot(F ~ les710, group=treatcd, data=both, type='l', auto.key=list(columns=2))
```

```{r compare_vol24}
ninds_ce <- subset(ninds, flike=='Cardioembolic Stroke' & !is.na(les24))
ninds_ce <- ninds_ce[order(ninds_ce$les24),]
treated <- subset(ninds_ce, treated)
placebo <- subset(ninds_ce, !treated)
treated$F <- 1
placebo$F <- 1
treated$F <- cumsum(treated$F)
placebo$F <- cumsum(placebo$F)
treated$F <- treated$F / max(treated$F)
placebo$F <- placebo$F / max(placebo$F)
both <- rbind(treated, placebo)
maybeICH24 <- xYplot(F ~ les24, group=treatcd, data=both, type='l', auto.key=list(columns=2))
maybeICH24
```

```{r compare_vol24noICH}
ninds_ce <- subset(ninds, flike=='Cardioembolic Stroke' & !is.na(les24) & !is.na(h36cens) & !h36cens)
ninds_ce <- ninds_ce[order(ninds_ce$les24),]
treated <- subset(ninds_ce, treated)
placebo <- subset(ninds_ce, !treated)
treated$F <- 1
placebo$F <- 1
treated$F <- cumsum(treated$F)
placebo$F <- cumsum(placebo$F)
treated$F <- treated$F / max(treated$F)
placebo$F <- placebo$F / max(placebo$F)
both <- rbind(treated, placebo)
noICH24 <- xYplot(F ~ les24, group=treatcd, data=both, type='l', lty=2,  auto.key=list(columns=2), label.curves=FALSE)
noICH24
```

```{r overlay_ICH}
noICH24 + maybeICH24
```

# Appendix

```{r summary, results='asis'}
latex(describe(ninds[, -which(names(ninds) %in% c('bmalcd'))]), file='')
```

Note that the `echo = FALSE` parameter was added to the code chunk to prevent printing of the R code that generated the plot.
